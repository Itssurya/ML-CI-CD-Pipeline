# ML Model API with Full CI/CD Pipeline

A complete end-to-end Machine Learning project featuring a FastAPI-based prediction API with automated CI/CD pipeline using GitHub Actions and Railway deployment.

## ğŸ“‹ Project Overview

This project demonstrates a production-ready ML API that:
- Trains a Random Forest classifier on the Iris dataset
- Serves predictions via a FastAPI REST API
- Includes comprehensive unit tests
- Automates testing and deployment with CI/CD pipelines
- Deploys to Railway using Docker

## ğŸ—ï¸ Project Structure

```
ML-CI-CD-Pipeline/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI application
â”‚   â””â”€â”€ model_loader.py      # Model loading utility
â”œâ”€â”€ model/
â”‚   â””â”€â”€ model.pkl            # Trained model (generated by train.py)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_api.py          # API endpoint tests
â”‚   â””â”€â”€ test_model.py        # Model tests
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml           # Continuous Integration workflow
â”‚       â””â”€â”€ deploy.yml       # Continuous Deployment workflow
â”œâ”€â”€ train.py                 # Model training script
â”œâ”€â”€ requirements.txt         # Python dependencies
â”œâ”€â”€ Dockerfile              # Docker configuration
â””â”€â”€ README.md               # This file
```

## ğŸš€ Quick Start

### Prerequisites

- Python 3.10+ (Python 3.12 supported)
- pip
- (Optional) Docker for containerized deployment

**Note:** If using Python 3.12, the requirements are automatically configured for compatibility. For Python 3.10-3.11, all versions work as specified.

### Local Setup

1. **Clone the repository**
   ```bash
   git clone <your-repo-url>
   cd ML-CI-CD-Pipeline
   ```

2. **Create and activate a virtual environment** âš ï¸ **REQUIRED**
   
   **Important:** Always use a virtual environment to avoid conflicts with system Python packages.
   
   ```bash
   # Create virtual environment
   python3 -m venv venv
   
   # Activate virtual environment
   # On Linux/Mac:
   source venv/bin/activate
   # On Windows:
   # venv\Scripts\activate
   ```
   
   **Verify activation:** Your terminal prompt should show `(venv)` at the beginning.
   
   ```bash
   # You should see (venv) in your prompt:
   (venv) user@machine:~/ML-CI-CD-Pipeline$
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```
   
   **Note:** If you see an "externally-managed-environment" error, make sure you've activated the virtual environment (step 2).

4. **Train the model**
   ```bash
   python train.py
   ```
   This will create `model/model.pkl` with the trained classifier.

5. **Run the FastAPI server**
   ```bash
   uvicorn app.main:app --reload
   ```

6. **Access the API**
   - API Documentation: http://localhost:8000/docs
   - Alternative docs: http://localhost:8000/redoc
   - Health check: http://localhost:8000/health
   - Root endpoint: http://localhost:8000/

### Making Predictions

**Using curl:**
```bash
curl -X POST "http://localhost:8000/predict" \
     -H "Content-Type: application/json" \
     -d '{"features": [5.1, 3.5, 1.4, 0.2]}'
```

**Using Python:**
```python
import requests

response = requests.post(
    "http://localhost:8000/predict",
    json={"features": [5.1, 3.5, 1.4, 0.2]}
)
print(response.json())
```

**Expected Response:**
```json
{
  "prediction": 0,
  "prediction_proba": [0.95, 0.03, 0.02],
  "class_name": "setosa"
}
```

## ğŸ³ Docker Deployment

### Build Docker Image

```bash
docker build -t ml-api:latest .
```

### Run Docker Container

```bash
docker run -p 8000:8000 ml-api:latest
```

**Note:** The Dockerfile expects the model to be trained before building. If you want to train inside Docker, you can modify the Dockerfile to include a training step.

### Docker Compose (Optional)

Create a `docker-compose.yml`:

```yaml
version: '3.8'

services:
  ml-api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
```

Run with:
```bash
docker-compose up --build
```

## ğŸ§ª Testing

### Run All Tests

```bash
pytest tests/ -v
```

### Run with Coverage

```bash
pytest tests/ -v --cov=app --cov-report=term-missing
```

### Run Specific Test Files

```bash
pytest tests/test_api.py -v
pytest tests/test_model.py -v
```

## ğŸ”„ CI/CD Pipeline

### Continuous Integration (CI)

The CI pipeline (`.github/workflows/ci.yml`) runs on every push and pull request:

1. **Code Checkout**
2. **Python Setup** (3.10)
3. **Dependency Installation**
4. **Linting** (flake8)
5. **Format Check** (black)
6. **Model Training**
7. **Unit Tests** (pytest)
8. **Model Artifact Upload**

### Continuous Deployment (CD)

The CD pipeline (`.github/workflows/deploy.yml`) runs on pushes to `main`:

1. **Code Checkout**
2. **Python Setup**
3. **Dependency Installation**
4. **Model Training**
5. **Docker Build**
6. **Deploy to Railway**

### Setting Up GitHub Actions

1. **Push your code to GitHub**
2. **CI will run automatically** on push/PR
3. **For CD**, you need to set up Railway secrets:

### Railway Deployment Setup

Railway offers two deployment methods:

#### Method 1: Auto-Deploy from GitHub (Recommended)

This is the simplest approach - Railway will automatically deploy when you push to your main branch.

1. **Create a Railway account** at https://railway.app
2. **Create a new project** â†’ "Deploy from GitHub repo"
3. **Select your repository** and connect it
4. **Railway will automatically:**
   - Detect the Dockerfile
   - Build and deploy on every push to main
   - Provide a public URL
   - Handle HTTPS automatically

**Note:** For this method, you need to ensure the model is trained before deployment. You can:
- Commit the trained model to the repository (add `model/model.pkl` to git)
- Or modify the Dockerfile to train the model during build

#### Method 2: GitHub Actions Deployment

Use the provided GitHub Actions workflow for more control:

1. **Get your Railway token:**
   - Go to Railway Dashboard â†’ Account Settings â†’ Tokens
   - Create a new token
2. **Get your Service ID:**
   - In Railway dashboard, go to your service
   - The Service ID is in the URL or service settings
3. **Add GitHub Secrets:**
   - Go to your GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions
   - Add `RAILWAY_TOKEN`: Your Railway API token
   - Add `RAILWAY_SERVICE_ID`: Your Railway service ID
4. **Push to main branch** - the workflow will deploy automatically

#### Method 3: Railway CLI Deployment

For manual deployments using Railway CLI:

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Initialize project
railway init

# Link to existing project (optional)
railway link

# Deploy
railway up
```

#### Railway Dockerfile Configuration

Railway automatically detects Dockerfiles in the root directory. Your `Dockerfile` is configured to:
- Use Python 3.10
- Install dependencies
- Expose port 8000
- Run FastAPI with uvicorn

**Important:** Make sure to train the model before building the Docker image, or modify the Dockerfile to include training.

## ğŸ“Š API Endpoints

### `GET /`
Root endpoint with API information.

**Response:**
```json
{
  "message": "ML Model API",
  "version": "1.0.0",
  "endpoints": {
    "predict": "/predict",
    "health": "/health",
    "docs": "/docs"
  }
}
```

### `GET /health`
Health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "model_loaded": true
}
```

### `POST /predict`
Predict Iris class from features.

**Request Body:**
```json
{
  "features": [5.1, 3.5, 1.4, 0.2]
}
```

**Response:**
```json
{
  "prediction": 0,
  "prediction_proba": [0.95, 0.03, 0.02],
  "class_name": "setosa"
}
```

**Class Mapping:**
- `0`: setosa
- `1`: versicolor
- `2`: virginica

## ğŸ› ï¸ Development

### Code Quality

- **Linting:** `flake8 .`
- **Formatting:** `black .`
- **Type Checking:** (Optional) Add `mypy` for type checking

### Adding New Features

1. Create a feature branch
2. Make your changes
3. Add tests
4. Run tests locally
5. Push and create a PR
6. CI will run automatically

## ğŸ“ Model Details

- **Algorithm:** Random Forest Classifier
- **Dataset:** Iris (150 samples, 4 features, 3 classes)
- **Features:**
  - Sepal length (cm)
  - Sepal width (cm)
  - Petal length (cm)
  - Petal width (cm)
- **Classes:**
  - Setosa
  - Versicolor
  - Virginica
- **Train/Test Split:** 80/20
- **Random State:** 42 (for reproducibility)

## ğŸ”§ Troubleshooting

### "externally-managed-environment" Error

**Error:** `error: externally-managed-environment` when running `pip install`

**Solution:** You must use a virtual environment. Follow these steps:

```bash
# 1. Create virtual environment
python3 -m venv venv

# 2. Activate it (Linux/Mac)
source venv/bin/activate

# 3. Verify it's activated (you should see (venv) in your prompt)
which python  # Should point to venv/bin/python

# 4. Now install dependencies
pip install -r requirements.txt
```

**Note:** If `python3 -m venv` fails, you may need to install `python3-venv`:
```bash
# On Ubuntu/Debian:
sudo apt install python3-venv python3-full
```

### Package Installation Errors

**Error:** `ModuleNotFoundError: No module named 'distutils'` or build failures with numpy

**Solution:** This occurs when using Python 3.12 with old package versions. The `requirements.txt` has been updated to use Python 3.12-compatible versions. If you still encounter issues:

```bash
# Make sure you're using the latest requirements.txt
pip install --upgrade pip
pip install -r requirements.txt
```

If you're using Python 3.10 or 3.11 and want to pin exact versions, you can modify `requirements.txt` to use `numpy==1.24.3` instead of `numpy>=1.26.0`.

### Model Not Found Error

If you see "Model file not found", run:
```bash
python train.py
```

### Port Already in Use

If port 8000 is busy, use a different port:
```bash
uvicorn app.main:app --port 8001
```

### Docker Build Fails

Ensure all dependencies are in `requirements.txt` and the Dockerfile is correct.

### Railway Deployment Issues

1. Check Railway logs in the dashboard
2. Verify `RAILWAY_TOKEN` and `RAILWAY_SERVICE_ID` secrets
3. Ensure Dockerfile is in the root directory

## ğŸ“š Technologies Used

- **Python 3.10**
- **FastAPI** - Modern web framework
- **Scikit-learn** - Machine learning
- **Pytest** - Testing framework
- **Docker** - Containerization
- **GitHub Actions** - CI/CD
- **Railway** - Cloud deployment

## ğŸ“„ License

This project is open source and available under the MIT License.

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## ğŸ“§ Contact

For questions or issues, please open an issue on GitHub.

---

**Happy Coding! ğŸš€**

# ML-CI-CD-Pipeline
